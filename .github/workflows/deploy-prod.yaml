- name: Set up SSH and deploy to YOLO Prod
  env:
    PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
    EC2_HOST: ${{ secrets.EC2_HOST }}
    EC2_USER: ${{ secrets.EC2_USERNAME }}
  run: |
    echo "$PRIVATE_KEY" > key.pem
    chmod 400 key.pem

    ssh -o StrictHostKeyChecking=no -i key.pem $EC2_USER@$EC2_HOST << 'EOF'
      set -e  # Exit on error

      cd /home/ubuntu

      if [ ! -d "yolo-prod" ]; then
        echo "ðŸ“¥ Cloning repo..."
        git clone https://github.com/DeemaAbuHwaij/YoloService.git yolo-prod
      fi

      cd yolo-prod

      echo "ðŸ§¹ Resetting local repo state..."
      git fetch origin
      git checkout main
      git reset --hard
      git clean -fd
      git pull origin main

      export TMPDIR=/tmp
      sudo mkdir -p "\$TMPDIR"
      sudo chmod 1777 "\$TMPDIR"

      echo "ðŸš€ Running deploy-prod.sh ..."
      bash ./deploy-prod.sh
    EOF
